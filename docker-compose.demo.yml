services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: vda
      POSTGRES_USER: vda
      POSTGRES_PASSWORD: vda
    ports:
      - "5436:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vda -d vda"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    ports:
      - "6382:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  gorse:
    image: zhenghaoz/gorse-in-one:latest
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      GORSE_CACHE_STORE: postgres://vda:vda@postgres:5432/vda?sslmode=disable
      GORSE_DATA_STORE: postgres://vda:vda@postgres:5432/vda?sslmode=disable
      GORSE_SERVER_API_KEY: vda-demo-key
    command: >
      -c /etc/gorse/config.toml
      --log-path /var/log/gorse/master.log
      --cache-path /var/lib/gorse/master
    ports:
      - "19086:8086"
      - "19088:8088"
    volumes:
      - ./configs/gorse/config.toml:/etc/gorse/config.toml:ro

  api:
    build:
      context: .
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      gorse:
        condition: service_started
    environment:
      PORT: 4020
      POLICY_VERSION: policy-v1
      DATA_VERSION: data-v1
      DATABASE_URL: postgres://vda:vda@postgres:5432/vda?sslmode=disable
      IDEMPOTENCY_TTL_SECONDS: 86400
      IDEMPOTENCY_CLEANUP_SECONDS: 30
      AUTH_TOKENS: dev-token:t_acme:dev-user,ops-token:t_ops:ops-user
      GORSE_BASE_URL: http://gorse:8088
      GORSE_API_KEY: vda-demo-key
      LLM_DEFAULT_PROVIDER: ollama
      LLM_DEFAULT_MODEL: glm-4.7-flash:latest
      LLM_REQUEST_TIMEOUT_SECONDS: 45
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_DEFAULT_MODEL: glm-4.7-flash:latest
      FRONTIER_BASE_URL: http://host.docker.internal:11434/v1
      FRONTIER_API_KEY: ""
      FRONTIER_DEFAULT_MODEL: glm-4.7-flash:latest
    ports:
      - "4020:4020"
